# Parfume CRM

Система управления клиентскими отношениями для парфюмерного бизнеса.

**GitHub:** https://github.com/coinsproject/crm_parfume

## Структура интерфейса

Приложение имеет следующие основные разделы:
- Dashboard
- Клиенты
- Заказы
- Партнёры
- Каталог
- Настройки

## Роли и права

Роли настраиваются через UI (Настройки -> Роли и права). Администратор создает роли и включает нужные права.

Базовые данные, которые предзагружаются в БД:
- ADMIN — системная роль, имеет все права.
- Базовые права:
  - dashboard.view
  - clients.view_all, clients.view_own, clients.create
  - orders.view_all, orders.view_own, orders.create
  - partners.view_all, partners.view_own
  - catalog.view_full, catalog.view_client, catalog.manage
- Пользователю назначается одна роль (user.role_id), доступ определяется правами роли.

## Управление пользователями

### Создание пользователей администратором

1. Администратор может создать пользователя напрямую через раздел "Настройки" → "Пользователи" → "Добавить пользователя"
2. Для новых пользователей устанавливаются:
   - Логин и email
   - Роль и, при необходимости, привязка к партнёру
   - Флаг "Активен" (is_active) по умолчанию false для новых пользователей, созданных из приглашения
   - Флаг "Ожидает активации" (pending_activation) true для новых пользователей, созданных из приглашения

### Регистрация по приглашению

1. Администратор может создать приглашение через "Настройки" → "Пользователи" → "Создать приглашение"
2. Приглашение включает:
   - Email получателя
   - Предполагаемую роль
   - Привязку к партнёру (опционально)
3. На основе приглашения генерируется одноразовая ссылка с токеном
4. По ссылке пользователь заполняет форму с логином и паролем
5. После заполнения формы создаётся аккаунт с флагами `is_active=False` и `pending_activation=True`
6. Администратор видит нового пользователя в списке с пометкой "Ожидает активации"
7. Администратор может:
   - Активировать пользователя (установит `is_active=True`, `pending_activation=False`)
   - Отклонить пользователя (удалит аккаунт)

### Активация учётных записей

После активации администратором пользователь может:
- Войти в систему
- Использовать функционал в соответствии с назначенной ролью
- Включить 2FA в своих настройках безопасности

## 2FA (Двухфакторная аутентификация)

### Логика включения:
- Только админ через /settings/users/{id}/edit и /settings/security (для себя).

### Логика при логине:
- Если is_2fa_enabled=True → показывается форма ввода кода, без неё попасть в систему нельзя.

## 2FA (Двухфакторная аутентификация)

### Логика включения:
- Только админ через /settings/users/{id}/edit и /settings/security (для себя).

### Логика при логине:
- Если is_2fa_enabled=True → показывается форма ввода кода, без неё попасть в систему нельзя.

## Установка

### Локальная установка

1. Установите зависимости: `pip install -r requirements.txt`
2. Настройте базу данных: `python init_db.py`
3. Запустите приложение: `python -m uvicorn app.main:app --host 127.0.0.1 --port 8000`

### Установка с Docker

#### Быстрый старт

1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd CRM
   ```

2. Создайте файл `.env` (опционально) для настройки переменных окружения:
   ```env
   SECRET_KEY=your-secret-key-here
   DATABASE_URL=sqlite:///./data/crm.db
   FRAGELLA_API_KEY=your-api-key-if-needed
   ```

3. Запустите с помощью Docker Compose:
   ```bash
   docker-compose up -d
   ```

4. Приложение будет доступно по адресу: http://localhost:8000

#### Ручная сборка Docker образа

```bash
# Сборка образа
docker build -t parfume-crm .

# Запуск контейнера
docker run -d \
  --name parfume-crm \
  -p 8000:8000 \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/logs:/app/logs \
  -e SECRET_KEY=your-secret-key \
  parfume-crm
```

#### Остановка и удаление

```bash
# Остановка
docker-compose down

# Остановка с удалением volumes (удалит данные БД!)
docker-compose down -v
```

#### Просмотр логов

```bash
docker-compose logs -f
```

## Безопасность

- Двухфакторная аутентификация (2FA) включена по умолчанию для всех новых пользователей
- Доступ к настройкам безопасности ограничен только для администраторов
- Рейт-лимиты для защиты от брутфорс-атак

## Ручное тестирование навигации

Для проверки корректности навигации выполните следующие шаги в свежем приватном окне браузера:
1. Откройте Dashboard
2. Пройдитесь по всем пунктам сайдбара (Клиенты, Заказы, Партнёры, Каталог, Настройки)
3. Убедитесь, что каждый пункт открывает соответствующую страницу:
   - Dashboard → /dashboard
   - Клиенты → /clients
   - Заказы → /orders
   - Партнёры → /partners
   - Каталог → /catalog
   - Настройки → /settings/security