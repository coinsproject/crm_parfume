# Оптимизация поиска прайса

## Что было оптимизировано

1. **Убраны лишние вызовы `count()`** - удалены 4 медленных подсчета в процессе фильтрации
2. **Оптимизирован финальный `count()`** - для больших результатов (>50,000) используется приблизительный подсчет
3. **Ограничен запрос брендов** - максимум 1000 брендов вместо всех
4. **Убрана проверка sample_items** - удалена медленная валидация фильтра hide_decant

## Ожидаемое улучшение производительности

- **5-10x ускорение** для страницы поиска при больших таблицах (90,000+ товаров)
- **Снижение нагрузки на CPU** на 80-90%
- **Быстрая загрузка страницы** даже без фильтров

## Применение на сервере

### 1. Обновите код

```bash
cd /opt/crm_parfume
sudo git pull origin main
```

### 2. Добавьте индексы для оптимизации (ВАЖНО!)

```bash
sudo docker-compose exec crm python add_price_indexes.py
```

Или вручную:

```bash
sudo docker-compose exec crm python -c "
from app.db import SessionLocal
import sqlalchemy as sa
db = SessionLocal()
try:
    db.execute(sa.text('CREATE INDEX IF NOT EXISTS idx_price_products_active ON price_products(is_active)'))
    db.execute(sa.text('CREATE INDEX IF NOT EXISTS idx_price_products_in_stock ON price_products(is_in_stock)'))
    db.execute(sa.text('CREATE INDEX IF NOT EXISTS idx_price_products_in_pricelist ON price_products(is_in_current_pricelist)'))
    db.execute(sa.text('CREATE INDEX IF NOT EXISTS idx_price_products_brand ON price_products(brand)'))
    db.execute(sa.text('CREATE INDEX IF NOT EXISTS idx_price_products_id_desc ON price_products(id DESC)'))
    db.execute(sa.text('CREATE INDEX IF NOT EXISTS idx_price_products_filter ON price_products(is_active, is_in_stock, is_in_current_pricelist)'))
    db.commit()
    print('✅ Indexes created successfully')
except Exception as e:
    print(f'❌ Error: {e}')
    db.rollback()
db.close()
"
```

### 3. Пересоберите и перезапустите контейнер

```bash
sudo docker-compose build --no-cache crm
sudo docker-compose up -d crm
```

Или используйте скрипт обновления:

```bash
sudo ./update.sh
```

### 4. Проверьте производительность

Откройте страницу поиска `/price/search` и проверьте:
- Страница должна загружаться быстро (< 2 секунд)
- CPU не должен быть загружен на 99%
- Поиск должен работать корректно

## Технические детали

### Удаленные вызовы count():
- `count_after_section` - после применения фильтра раздела
- `count_after_pf` - после применения фильтров парфюма
- `count_before_filter` и `count_after_filter` - для фильтра hide_decant
- Проверка `sample_items` - валидация фильтра hide_decant

### Оптимизация финального count():
- Если есть фильтры (q, brand, ptype и т.д.) - точный подсчет
- Если фильтров нет - приблизительный подсчет (максимум 50,000)
- Это позволяет быстро показывать результаты даже для 90,000+ товаров

### Ограничение брендов:
- Максимум 1000 брендов вместо всех
- Ускоряет загрузку страницы поиска
- Для большинства случаев этого достаточно

## Откат изменений (если нужно)

Если возникнут проблемы, можно откатиться:

```bash
cd /opt/crm_parfume
sudo git log --oneline -5  # Найдите commit до оптимизации
sudo git checkout <commit_hash> app/routes/price.py
sudo docker-compose restart crm
```

