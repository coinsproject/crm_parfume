{% extends "layout.html" %}
{% block title %}Запрос на закупку #{{ purchase_request.id }}{% endblock %}
{% block page_title %}Запрос на закупку #{{ purchase_request.id }}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <strong>Партнёр:</strong> {{ purchase_request.partner.name if purchase_request.partner else '-' }}
                </div>
                <div class="col-md-3">
                    <strong>Статус:</strong>
                    {% if purchase_request.status == 'NEW' %}
                    <span class="badge bg-info">Новый</span>
                    {% elif purchase_request.status == 'draft' %}
                    <span class="badge bg-secondary">Черновик</span>
                    {% elif purchase_request.status == 'submitted' %}
                    <span class="badge bg-primary">Отправлен</span>
                    {% elif purchase_request.status == 'PENDING_APPROVAL' %}
                    <span class="badge bg-warning">Отправлен на подтверждение</span>
                    {% elif purchase_request.status == 'partially_received' %}
                    <span class="badge bg-warning">Частично получен</span>
                    {% elif purchase_request.status == 'fully_received' %}
                    <span class="badge bg-success">Получен</span>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <strong>Ожидаемая дата:</strong> {{ purchase_request.expected_delivery_date.strftime('%d.%m.%Y') if purchase_request.expected_delivery_date else '-' }}
                </div>
                <div class="col-md-3">
                    <strong>Создан:</strong> {{ purchase_request.created_at.strftime('%d.%m.%Y %H:%M') if purchase_request.created_at else '-' }}
                </div>
                {% if purchase_request.notes %}
                <div class="col-12">
                    <strong>Заметки:</strong> {{ purchase_request.notes }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between">
            <h5 class="mb-0">Заказы в запросе</h5>
            {% if is_admin %}
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addOrdersModal">Добавить заказы</button>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Клиент</th>
                            <th>Сумма</th>
                            <th>Позиций</th>
                            <th>Дата</th>
                            {% if purchase_request.status == 'draft' %}
                            <th></th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in purchase_request.orders %}
                        <tr>
                            <td><a href="/orders/{{ order.id }}">#{{ order.id }}</a></td>
                            <td>{{ order.client.name if order.client else '-' }}</td>
                            <td>{{ order.total_client_amount or order.total_amount }}</td>
                            <td>{{ order.items|length if order.items else 0 }}</td>
                            <td>{{ order.created_at.strftime('%d.%m.%Y') if order.created_at else '-' }}</td>
                            {% if purchase_request.status == 'draft' %}
                            <td>
                                <form method="post" action="/purchase_requests/{{ purchase_request.id }}/remove_order/{{ order.id }}" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Удалить заказ из запроса?')">Удалить</button>
                                </form>
                            </td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-muted">Нет заказов</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Агрегированные позиции</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Наименование</th>
                            <th>Количество</th>
                            <th>Цена за единицу</th>
                            <th>Общая стоимость</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in aggregated_items %}
                        <tr>
                            <td>{{ item.name }}</td>
                            <td>{{ item.qty }}</td>
                            <td>
                                {% if item.display_price and item.display_price != item.original_price %}
                                <span class="text-decoration-line-through text-muted">{{ item.original_price }}</span>
                                <span class="text-danger fw-bold">{{ item.display_price }}</span>
                                {% else %}
                                {{ item.original_price or '-' }}
                                {% endif %}
                            </td>
                            <td>{{ item.total_cost }}</td>
                            <td>
                                {% if item.status == 'new' %}
                                <span class="badge bg-info">Новый товар</span>
                                {% elif item.status == 'price_changed' %}
                                <span class="badge bg-warning">Цена изменена</span>
                                {% elif item.status == 'pending_approval' %}
                                <span class="badge bg-warning">Ожидает подтверждения</span>
                                {% elif item.status == 'confirmation' %}
                                <span class="badge bg-success">Подтверждение</span>
                                {% elif item.status == 'approved' %}
                                <span class="badge bg-success">Подтверждён</span>
                                {% elif item.status == 'rejected' %}
                                <span class="badge bg-danger">Отклонён</span>
                                {% else %}
                                <span class="badge bg-secondary">Обычный</span>
                                {% endif %}
                                {% if item.price_change_comment %}
                                <br><small class="text-muted">{{ item.price_change_comment }}</small>
                                {% endif %}
                            </td>
                            {% if is_admin %}
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#priceChangeModal"
                                        onclick="setPriceChangeData({{ loop.index }}, '{{ item.name|e }}', {{ item.original_price or 0 }}, {{ item.order_item_id }})">
                                    Изменить цену
                                </button>
                            </td>
                            {% elif (item.status == 'pending_approval' or (item.status == 'new' and is_admin)) and item.request_item_id %}
                            <td>
                                <form method="post" action="/purchase_requests/{{ purchase_request.id }}/approve_price/{{ item.request_item_id }}" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-success">Подтвердить</button>
                                </form>
                                {% if item.status == 'pending_approval' %}
                                <form method="post" action="/purchase_requests/{{ purchase_request.id }}/reject_price/{{ item.request_item_id }}" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger">Отклонить</button>
                                </form>
                                {% endif %}
                            </td>
                            {% else %}
                            <td>-</td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-muted">Нет позиций</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">Управление статусом (Админ)</h5>
        </div>
        <div class="card-body">
            <form method="post" action="/purchase_requests/{{ purchase_request.id }}/update_status">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Статус</label>
                        <select class="form-select" name="status" required>
                            <option value="NEW" {% if purchase_request.status == 'NEW' %}selected{% endif %}>Новый</option>
                            <option value="draft" {% if purchase_request.status == 'draft' %}selected{% endif %}>Черновик</option>
                            <option value="submitted" {% if purchase_request.status == 'submitted' %}selected{% endif %}>Отправлен</option>
                            <option value="PENDING_APPROVAL" {% if purchase_request.status == 'PENDING_APPROVAL' %}selected{% endif %}>Отправлен на подтверждение</option>
                            <option value="partially_received" {% if purchase_request.status == 'partially_received' %}selected{% endif %}>Частично получен</option>
                            <option value="fully_received" {% if purchase_request.status == 'fully_received' %}selected{% endif %}>Получен полностью</option>
                            <option value="cancelled" {% if purchase_request.status == 'cancelled' %}selected{% endif %}>Отменён</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Фактическая дата получения</label>
                        <input type="date" class="form-control" name="actual_delivery_date" 
                               value="{{ purchase_request.actual_delivery_date.strftime('%Y-%m-%d') if purchase_request.actual_delivery_date else '' }}">
                    </div>
                    <div class="col-md-12">
                        <label class="form-label">Заметки админа</label>
                        <textarea class="form-control" name="admin_notes" rows="2">{{ purchase_request.admin_notes or '' }}</textarea>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Сохранить статус</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="mt-3">
        {% if (purchase_request.status == 'NEW' or purchase_request.status == 'draft') and not is_admin %}
        <form method="post" action="/purchase_requests/{{ purchase_request.id }}/submit" class="d-inline">
            <button type="submit" class="btn btn-primary" onclick="return confirm('Отправить запрос на закупку?')">Отправить на закупку</button>
        </form>
        {% endif %}
        {% if is_admin and purchase_request.status in ['NEW', 'submitted'] %}
        <form method="post" action="/purchase_requests/{{ purchase_request.id }}/send_for_approval" class="d-inline">
            <button type="submit" class="btn btn-warning" onclick="return confirm('Отправить запрос на подтверждение поставщику? Все новые позиции будут помечены как подтверждённые.')">Отправить на подтверждение</button>
        </form>
        {% endif %}
        <a href="/purchase_requests" class="btn btn-outline-secondary">Назад</a>
    </div>
</div>

{% if is_admin %}
<!-- Modal для добавления заказов -->
<div class="modal fade" id="addOrdersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить заказы</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/purchase_requests/{{ purchase_request.id }}/add_orders">
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-modal"></th>
                                    <th>ID</th>
                                    <th>Клиент</th>
                                    <th>Сумма</th>
                                    <th>Дата</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in available_orders %}
                                <tr>
                                    <td><input type="checkbox" name="order_ids" value="{{ order.id }}"></td>
                                    <td>#{{ order.id }}</td>
                                    <td>{{ order.client.name if order.client else '-' }}</td>
                                    <td>{{ order.total_client_amount or order.total_amount }}</td>
                                    <td>{{ order.created_at.strftime('%d.%m.%Y') if order.created_at else '-' }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-muted">Нет доступных заказов</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
document.getElementById('select-all-modal')?.addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('#addOrdersModal input[name="order_ids"]');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
});
</script>
{% endif %}

{% if is_admin %}
<!-- Modal для изменения цены -->
<div class="modal fade" id="priceChangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Изменение цены</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/purchase_requests/{{ purchase_request.id }}/change_price" id="priceChangeForm">
                <input type="hidden" name="order_item_id" id="priceChangeOrderItemId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Товар</label>
                        <input type="text" class="form-control" id="priceChangeItemName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Исходная цена</label>
                        <input type="text" class="form-control" id="priceChangeOriginalPrice" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Новая цена</label>
                        <input type="number" step="0.01" class="form-control" name="new_price" id="priceChangeNewPrice" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Комментарий к изменению цены</label>
                        <textarea class="form-control" name="price_change_comment" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить и отправить на подтверждение</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
function setPriceChangeData(index, name, originalPrice, orderItemId) {
    document.getElementById('priceChangeItemName').value = name;
    document.getElementById('priceChangeOriginalPrice').value = originalPrice;
    document.getElementById('priceChangeOrderItemId').value = orderItemId;
    document.getElementById('priceChangeNewPrice').value = originalPrice;
}
</script>
{% endif %}
{% endblock %}

