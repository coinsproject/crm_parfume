{% extends "layout.html" %}

{% block title %}{{ fragrance.name }} - {{ fragrance.brand }} - Parfume CRM{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    {% include "partials/sidebar.html" %}

    <!-- Main Content -->
    <main class="main-content">
        <!-- Topbar -->
        <header class="topbar">
            <div class="container-fluid">
                <div class="topbar-content">
                    <h1 class="topbar-title">{{ fragrance.name }} - {{ fragrance.brand }}</h1>
                    <div class="topbar-actions">
                        <div class="search-form">
                            <input type="text" class="form-control" placeholder="Поиск...">
                        </div>
                        <div class="user-profile">
                            <div class="user-avatar">{{ current_user.username[0:2].upper() }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Fragrance Details Content -->
        <div class="container-fluid">
            <div class="row">
                <!-- Main Info Card -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">Информация об аромате</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="fragrance-image-container">
                                        {% if fragrance.image_url %}
                                            <img src="{{ fragrance.image_url }}" alt="{{ fragrance.name }}" class="img-fluid rounded">
                                        {% else %}
                                            <div class="no-image-placeholder">
                                                <i class="fas fa-bottle fa-3x"></i>
                                                <p>Изображение отсутствует</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="fragrance-details">
                                        <h2>{{ fragrance.name }}</h2>
                                        <p class="fragrance-brand">{{ fragrance.brand }}</p>
                                        
                                        <div class="fragrance-meta">
                                            {% if fragrance.year %}
                                            <div class="meta-item">
                                                <strong>Год выпуска:</strong> {{ fragrance.year }}
                                            </div>
                                            {% endif %}
                                            
                                            {% if fragrance.gender %}
                                            <div class="meta-item">
                                                <strong>Пол:</strong> 
                                                {% if fragrance.gender == "MALE" %}Мужской{% elif fragrance.gender == "FEMALE" %}Женский{% elif fragrance.gender == "UNISEX" %}Унисекс{% else %}{{ fragrance.gender }}{% endif %}
                                            </div>
                                            {% endif %}
                                            
                                            {% if fragrance.oil_type %}
                                            <div class="meta-item">
                                                <strong>Тип аромата:</strong> {{ fragrance.oil_type }}
                                            </div>
                                            {% endif %}
                                            
                                            {% if fragrance.rating %}
                                            <div class="meta-item">
                                                <strong>Рейтинг:</strong> 
                                                <span class="rating-stars">
                                                    {% for i in range(5) %}
                                                        {% if i < (fragrance.rating or 0)|int %}
                                                            <i class="fas fa-star text-warning"></i>
                                                        {% else %}
                                                            <i class="far fa-star text-muted"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </span>
                                                ({{ "{:.1f}".format(fragrance.rating) }})
                                            </div>
                                            {% endif %}
                                            
                                            {% if fragrance.price %}
                                            <div class="meta-item">
                                                <strong>Цена:</strong> {{ "{:,.0f}".format(fragrance.price) }} ₽
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Pyramid -->
                    {% if fragrance.notes %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">Пирамида аромата</h3>
                        </div>
                        <div class="card-body">
                            <div class="notes-pyramid">
                                <div class="note-group">
                                    <h5>Верхние ноты</h5>
                                    <div class="note-list">
                                        {% for note in fragrance.notes.top or [] %}
                                        <span class="note-badge">{{ note }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <div class="note-group">
                                    <h5>Ноты сердца</h5>
                                    <div class="note-list">
                                        {% for note in fragrance.notes.middle or [] %}
                                        <span class="note-badge">{{ note }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <div class="note-group">
                                    <h5>Базовые ноты</h5>
                                    <div class="note-list">
                                        {% for note in fragrance.notes.base or [] %}
                                        <span class="note-badge">{{ note }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Accords -->
                    {% if fragrance.main_accords %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">Основные аккорды</h3>
                        </div>
                        <div class="card-body">
                            <div class="accords-container">
                                {% for accord in fragrance.main_accords %}
                                <div class="accord-item">
                                    <div class="accord-name">{{ accord.name }}</div>
                                    <div class="accord-bar">
                                        <div class="accord-progress" style="width: 0%;" data-percentage="{{ accord.percentage|default(0) }}"></div>
                                    </div>
                                    <div class="accord-percent">{{ accord.percentage if accord.percentage else 0 }}%</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sidebar with additional info -->
                <div class="col-lg-4">
                    <!-- Longevity & Sillage -->
                    {% if fragrance.longevity or fragrance.sillage %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">Стойкость и шлейф</h3>
                        </div>
                        <div class="card-body">
                            {% if fragrance.longevity %}
                            <div class="attribute-row">
                                <span class="attribute-label">Стойкость:</span>
                                <span class="attribute-value">{{ fragrance.longevity }}</span>
                            </div>
                            {% endif %}
                            
                            {% if fragrance.sillage %}
                            <div class="attribute-row">
                                <span class="attribute-label">Шлейф:</span>
                                <span class="attribute-value">{{ fragrance.sillage }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Seasons & Occasions -->
                    {% if fragrance.seasons or fragrance.occasions %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">Сезонность и случаи использования</h3>
                        </div>
                        <div class="card-body">
                            {% if fragrance.seasons %}
                            <div class="seasons-container">
                                <h5>Сезоны:</h5>
                                {% for season in fragrance.seasons %}
                                <span class="season-badge" title="{{ season.season }} ({{ "{:.0%}".format(season.score) }})">
                                    {{ season.season }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            
                            {% if fragrance.occasions %}
                            <div class="occasions-container mt-3">
                                <h5>Случаи использования:</h5>
                                {% for occasion in fragrance.occasions %}
                                <span class="occasion-badge" title="{{ occasion.occasion }} ({{ "{:.0%}".format(occasion.score) }})">
                                    {{ occasion.occasion }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Actions -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">Действия</h3>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary">Добавить в заказ</button>
                                <button class="btn btn-outline-secondary">Добавить в избранное</button>
                                {% if current_user.role.name in ['ADMIN', 'MANAGER'] %}
                                <button class="btn btn-outline-warning">Редактировать</button>
                                <button class="btn btn-outline-danger">Удалить</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block styles %}
<style>
.fragrance-image-container {
    text-align: center;
    padding: 1rem;
}

.no-image-placeholder {
    height: 300px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: #f8fafc;
    border: 1px dashed #cbd5e1;
    border-radius: 0.5rem;
    color: #94a3b8;
}

.notes-pyramid {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.note-group {
    margin-bottom: 1rem;
}

.note-group h5 {
    margin-bottom: 0.75rem;
    color: #334155;
    border-bottom: 1px solid #e2e8f0;
    padding-bottom: 0.5rem;
}

.note-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.note-badge {
    background-color: #dbeafe;
    color: #1e3a8a;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
}

.accords-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.accord-item {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.accord-name {
    flex: 1;
    font-weight: 500;
    color: #334155;
}

.accord-bar {
    flex: 2;
    height: 1rem;
    background-color: #e2e8f0;
    border-radius: 0.5rem;
    overflow: hidden;
}

.accord-progress {
    height: 100%;
    background: linear-gradient(to right, #6366f1, #8b5cf6);
    border-radius: 0.5rem;
}

.accord-percent {
    min-width: 40px;
    text-align: right;
    font-size: 0.875rem;
    color: #64748b;
}

.attribute-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f5f9;
}

.attribute-label {
    font-weight: 500;
    color: #64748b;
}

.attribute-value {
    color: #1e293b;
}

.seasons-container, .occasions-container {
    margin-top: 1rem;
}

.season-badge, .occasion-badge {
    display: inline-block;
    background-color: #f1f5f9;
    color: #475569;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
}

@media (max-width: 768px) {
    .notes-pyramid {
        gap: 1rem;
    }
    
    .accord-item {
        flex-direction: column;
        align-items: flex-start;
    }
    
.accord-bar {
    width: 100%;
}
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.accord-progress').forEach(function(el) {
        const pct = el.getAttribute('data-percentage') || '0';
        const value = parseFloat(pct) || 0;
        el.style.width = `${value}%`;
    });
});
</script>
{% endblock %}
