{% extends "layout.html" %}

{% block title %}Создать приглашение - Parfume CRM{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Sidebar -->
    {% include "partials/sidebar.html" %}

    <!-- Main Content -->
    <main class="main-content">
        <!-- Topbar -->
        <header class="topbar">
            <div class="container-fluid">
                <div class="topbar-content">
                    <h1 class="topbar-title">Создать приглашение</h1>
                    <div class="topbar-actions">
                        <div class="search-form">
                            <input type="text" class="form-control" placeholder="Поиск...">
                        </div>
                        <div class="user-profile">
                            <div class="user-avatar">ПМ</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Create Invitation Content -->
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Форма приглашения</h3>
                        </div>
                        <div class="card-body">
                            <form id="createInvitationForm">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="role" class="form-label">Роль</label>
                                    <select class="form-control" id="role" name="role_id" required>
                                        <option value="">Выберите роль</option>
                                        {% for role in roles %}
                                        <option value="{{ role.id }}">{{ role.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3" id="partnerField" style="display: none;">
                                    <label for="partner" class="form-label">Партнёр</label>
                                    <select class="form-control" id="partner" name="partner_id">
                                        <option value="">Не выбран</option>
                                        {% for partner in partners %}
                                        <option value="{{ partner.id }}">{{ partner.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">Создать приглашение</button>
                                <a href="/admin/invitations" class="btn btn-secondary">Отмена</a>
                            </form>
                            
                            <div id="resultMessage" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Информация</h3>
                        </div>
                        <div class="card-body">
                            <p>При создании приглашения:</p>
                            <ul>
                                <li>На указанный email будет сгенерирована уникальная ссылка</li>
                                <li>Срок действия приглашения: 7 дней</li>
                                <li>Приглашение можно использовать только один раз</li>
                                <li>После принятия приглашения пользователь получит указанную роль</li>
                            </ul>
                            
                            <div id="invitationLink" class="mt-3" style="display: none;">
                                <h5>Ссылка для приглашения:</h5>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="invitationLinkInput" readonly>
                                    <button class="btn btn-outline-secondary" type="button" id="copyLinkBtn">Копировать</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Показываем/скрываем поле партнёра в зависимости от выбранной роли
    const roleSelect = document.getElementById('role');
    const partnerField = document.getElementById('partnerField');
    
    roleSelect.addEventListener('change', function() {
        if (this.value === '3') { // PARTNER role id
            partnerField.style.display = 'block';
        } else {
            partnerField.style.display = 'none';
        }
    });
    
    // Обработка формы создания приглашения
    const form = document.getElementById('createInvitationForm');
    const resultMessage = document.getElementById('resultMessage');
    const invitationLinkDiv = document.getElementById('invitationLink');
    const invitationLinkInput = document.getElementById('invitationLinkInput');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {
            email: formData.get('email'),
            role_id: parseInt(formData.get('role_id')),
            partner_id: formData.get('partner_id') ? parseInt(formData.get('partner_id')) : null
        };
        
        try {
            const response = await fetch('/admin/invitations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    email: data.email,
                    role_id: data.role_id,
                    partner_id: data.partner_id
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                resultMessage.innerHTML = `
                    <div class="alert alert-success">
                        Приглашение успешно создано!
                    </div>
                `;
                resultMessage.style.display = 'block';
                
                // Показываем ссылку
                const link = window.location.origin + '/invite/' + result.invitation_token;
                invitationLinkInput.value = link;
                invitationLinkDiv.style.display = 'block';
                
                // Добавляем обработчик для кнопки копирования
                copyLinkBtn.onclick = function() {
                    invitationLinkInput.select();
                    document.execCommand('copy');
                    
                    // Меняем текст кнопки на короткое время
                    const originalText = copyLinkBtn.textContent;
                    copyLinkBtn.textContent = 'Скопировано!';
                    
                    setTimeout(function() {
                        copyLinkBtn.textContent = originalText;
                    }, 2000);
                };
            } else {
                resultMessage.innerHTML = `
                    <div class="alert alert-danger">
                        Ошибка: ${result.detail || 'Неизвестная ошибка'}
                    </div>
                `;
                resultMessage.style.display = 'block';
            }
        } catch (error) {
            resultMessage.innerHTML = `
                <div class="alert alert-danger">
                    Ошибка соединения: ${error.message}
                </div>
            `;
            resultMessage.style.display = 'block';
        }
    });
});
</script>
{% endblock %}
