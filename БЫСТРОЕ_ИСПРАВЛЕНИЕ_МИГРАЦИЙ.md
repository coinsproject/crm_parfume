# Быстрое исправление миграций

## Проблема
Alembic пытается применить миграции с начала, но таблицы уже существуют. Это значит, что таблица `alembic_version` не содержит правильной информации о примененных миграциях.

## Решение

### Шаг 1: Определите текущее состояние БД

```bash
cd /opt/crm_parfume
sudo git pull origin main
chmod +x fix_alembic_version.sh
sudo ./fix_alembic_version.sh
```

### Шаг 2: Проштампуйте БД на правильную версию

Проверьте, есть ли поля `is_published_to_partners` и `max_partner_views` в таблице `release_notes`:

```bash
sudo docker-compose exec crm python -c "
from app.db import engine
from sqlalchemy import text
with engine.connect() as conn:
    result = conn.execute(text('PRAGMA table_info(release_notes)'))
    cols = [row[1] for row in result.fetchall()]
    print('Колонки:', cols)
    print('is_published_to_partners:', 'is_published_to_partners' in cols)
    print('max_partner_views:', 'max_partner_views' in cols)
"
```

### Шаг 3: Проштампуйте БД

**Если поля НЕТ** (нужно применить миграцию):
```bash
# Проштампуйте на версию перед нужной миграцией
sudo docker-compose exec crm alembic stamp 31a69389712b

# Затем примените недостающую миграцию
sudo docker-compose exec crm alembic upgrade head
```

**Если поля УЖЕ ЕСТЬ** (миграция уже применена вручную):
```bash
# Проштампуйте на последнюю версию
sudo docker-compose exec crm alembic stamp 20260126015515
```

### Шаг 4: Проверьте результат

```bash
# Проверьте текущую версию
sudo docker-compose exec crm alembic current

# Проверьте структуру таблицы
sudo docker-compose exec crm python -c "
from app.db import engine
from sqlalchemy import inspect
inspector = inspect(engine)
cols = [col['name'] for col in inspector.get_columns('release_notes')]
print('is_published_to_partners:', 'is_published_to_partners' in cols)
print('max_partner_views:', 'max_partner_views' in cols)
"

# Перезапустите контейнер
sudo docker-compose restart crm
```

## Альтернативный способ (если ничего не помогает)

Если миграции не применяются, можно добавить колонки вручную:

```bash
sudo docker-compose exec crm python -c "
from app.db import engine
from sqlalchemy import text
with engine.connect() as conn:
    # Добавляем колонки вручную
    try:
        conn.execute(text('ALTER TABLE release_notes ADD COLUMN is_published_to_partners BOOLEAN DEFAULT 0'))
        print('Колонка is_published_to_partners добавлена')
    except Exception as e:
        print('Ошибка при добавлении is_published_to_partners:', e)
    
    try:
        conn.execute(text('ALTER TABLE release_notes ADD COLUMN max_partner_views INTEGER'))
        print('Колонка max_partner_views добавлена')
    except Exception as e:
        print('Ошибка при добавлении max_partner_views:', e)
    
    conn.commit()
    
    # Проштампуйте на последнюю версию
    import subprocess
    subprocess.run(['alembic', 'stamp', '20260126015515'])
"
```

